<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./css/style.css" />
    <title>Payment Api Gateway</title>
  </head>
  <body>
    <div class="mainContainer">
      <div class="displayContainer">
        <div class="container_body">
          <h1>Bitcoin_testnet Payment Box</h1>
          <div class="qr_amount">
            <div class="displayQR">
              <img
                src="https://www.w3schools.com/images/w3schools_green.jpg"
                alt="QR Code Image"
              />
            </div>
            <div class="displayDetails">
              <h3>Send <span id="amount"></span> TBTC</h3>
              <input type="text" value="2Msfo499v8x4UzwxBtCnsLeFjcS9dex39t7" />
              <p>
                or scan QR Code with your mobile device<br />If you send any
                other TBTC amount, payment system will ignore it!
              </p>
            </div>
          </div>
          <button id="payBtn" onclick="pay()">Pay Now</button>
          <p id="timeLeft"><span></span></p>
          <p id="messageTxt"></p>
        </div>
      </div>
    </div>
    <script>
      var amount;
      window.onload = () => {
        console.log(document.location.href);
        var url = document.location.href,
          params = url.split("?")[1].split("&"),
          data = {},
          tmp;
        for (var i = 0, l = params.length; i < l; i++) {
          tmp = params[i].split("=");
          data[tmp[0]] = tmp[1];
        }
        console.log(data.amount);
        amount = data.amount;
        document.getElementById("amount").innerHTML = data.amount;
      };
      const pay = async () => {
        var presentTime = 0 + ":" + 20;
        document.getElementById("timeLeft").innerHTML = presentTime;
        const myinterval = setInterval(async () => {
          var presentTime = document.getElementById("timeLeft").innerHTML;
          var timeArray = presentTime.split(/[:]+/);
          var m = timeArray[0];
          var s = checkSecond(timeArray[1] - 1);
          if (s == 59) {
            m = m - 1;
          }
          if (s == "00") {
            console.log("timer stopped");
            await fetch("http://localhost:8000/cancle-request");
            clearInterval(myinterval);
          }
          if (m < 0) {
            return;
          }
          document.getElementById("timeLeft").innerHTML = m + ":" + s;
        }, 1000);

        function checkSecond(sec) {
          if (sec < 10 && sec >= 0) {
            sec = "0" + sec;
          } // add zero in front of numbers < 10
          if (sec < 0) {
            sec = "59";
          }
          return sec;
        }

        document.getElementById("payBtn").disabled = true;
        document.getElementById("messageTxt").innerHTML = "Awaiting Payment";
        // document.getElementById("timeLeft").innerHTML = `Time Left : ${date}`;
        const url = "http://localhost:8000/request?id=1";
        let response = await fetch(url);
        let data = await response.json();
        console.log(data);
        if (data.status == "success") {
          let response = await fetch(
            "http://localhost:8000/payment-statuts?id=1"
          );
          let data = await response.json();
          if (data.status == "approved") {
            document.getElementById("payBtn").disabled = false;
            document.getElementById("messageTxt").innerHTML =
              "Payment Paid Successfully";
            document.getElementById("timeLeft").innerHTML = "";
            clearInterval(myinterval);
          }
          console.log(data);
        }
      };
    </script>
  </body>
</html>
